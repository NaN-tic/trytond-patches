# HG changeset patch
# User Sergi Almacellas Abellana <sergi@koolpi.com>
Add company domain on analytic entries


issue5104

review17991002

Index: trytond/trytond/modules/analytic_sale/sale.py
===================================================================

--- a/trytond/trytond/modules/analytic_sale/sale.py
+++ b/trytond/trytond/modules/analytic_sale/sale.py
@@ -1,5 +1,6 @@
 # This file is part of Tryton.  The COPYRIGHT file at the top level of
 # this repository contains the full copyright notices and license terms.
+from trytond.model import fields
 from trytond.pool import Pool, PoolMeta

 from trytond.modules.analytic_account import AnalyticMixin
@@ -32,3 +33,22 @@
     def _get_origin(cls):
         origins = super(AnalyticAccountEntry, cls)._get_origin()
         return origins + ['sale.line']
+
+    @fields.depends('origin')
+    def on_change_with_company(self, name=None):
+        pool = Pool()
+        SaleLine = pool.get('sale.line')
+        company = super(AnalyticAccountEntry, self).on_change_with_company(
+            name)
+        if isinstance(self.origin, SaleLine):
+            if self.origin.sale:
+                return self.origin.sale.company.id
+        return company
+
+    @classmethod
+    def search_company(cls, name, clause):
+        domain = super(AnalyticAccountEntry, cls).search_company(name, clause)
+        return ['OR',
+            domain,
+            [('origin.sale.company',) + tuple(clause[1:]) +
+                tuple(('sale.line',))]]

